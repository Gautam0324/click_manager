<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL & Device Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Add Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Google Fonts for Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #1e3a8a, #4c1d95);
            min-height: 100vh;
            font-family: 'Poppins', sans-serif;
            color: #e2e8f0;
        }
        .container {
            max-width: 1200px;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            transition: all 0.3s ease;
            animation: fadeIn 0.6s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border-color: #a855f7;
        }
        .selected-row {
            background-color: rgba(59, 130, 246, 0.2);
        }
        .btn-primary {
            background: linear-gradient(90deg, #a855f7, #ec4899);
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.5);
        }
        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(168, 85, 247, 0.8);
        }
        .btn-danger {
            background: linear-gradient(90deg, #ef4444, #b91c1c);
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
        }
        .btn-danger:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(239, 68, 68, 0.8);
        }
        .alert {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            animation: slideInRight 0.5s ease-in-out;
        }
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        tr {
            animation: slideInLeft 0.5s ease-in-out;
        }
        .action-btn {
            transition: all 0.3s ease;
        }
        .action-btn:hover {
            transform: scale(1.2);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        .modal-content {
            animation: popIn 0.3s ease-in-out;
        }
        input, select {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #e2e8f0;
            transition: all 0.3s ease;
        }
        input:focus, select:focus {
            border-color: #a855f7;
            box-shadow: 0 0 10px rgba(168, 85, 247, 0.3);
        }
        label {
            color: #a0aec0;
        }
        table {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        th, td {
            border-color: rgba(255, 255, 255, 0.1);
        }
        thead {
            background: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="py-8">
    <div class="container mx-auto px-4">
        <h1 class="text-4xl font-bold text-center mb-10 bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-600 animate-pulse">
            URL & Device Management System
        </h1>

        <!-- Alert -->
        <div id="alert" class="hidden fixed top-4 right-4 z-50 p-4 rounded-lg text-white alert">
            <span id="alert-message"></span>
            <button onclick="this.parentElement.classList.add('hidden')" class="ml-4 text-white">Ã—</button>
        </div>

        <!-- Selected Items Summary -->
        <div class="card shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-semibold text-gray-100 mb-4">Selected for Script</h2>
            <div id="selected-summary" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="text-lg font-medium text-gray-300">Selected URLs</h3>
                    <ul id="selected-urls" class="list-disc pl-5 text-gray-400"></ul>
                </div>
                <div>
                    <h3 class="text-lg font-medium text-gray-300">Selected Devices</h3>
                    <ul id="selected-devices" class="list-disc pl-5 text-gray-400"></ul>
                </div>
            </div>
            <div class="mt-4 flex space-x-4">
                <button class="btn-primary text-white font-medium py-2 px-6 rounded-lg flex items-center space-x-2" onclick="runScript()">
                    <i class="fas fa-play"></i>
                    <span>Run Script</span>
                </button>
                <button class="btn-danger text-white font-medium py-2 px-6 rounded-lg flex items-center space-x-2" onclick="stopScript()">
                    <i class="fas fa-stop"></i>
                    <span>Stop Script</span>
                </button>
            </div>
        </div>

        <!-- Add URL Form -->
        <div class="card shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-semibold text-gray-100 mb-4">Add New URL</h2>
            <form id="url-form" method="POST" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="url" class="block text-sm font-medium">URL</label>
                    <input type="text" id="url" name="url" class="mt-1 block w-full rounded-md shadow-sm" required>
                </div>
                <div>
                    <label for="target" class="block text-sm font-medium">Target Clicks</label>
                    <input type="number" id="target" name="target" class="mt-1 block w-full rounded-md shadow-sm" required>
                </div>
                <div>
                    <label for="unique" class="block text-sm font-medium">Unique Percent</label>
                    <input type="number" step="0.01" id="unique" name="unique" class="mt-1 block w-full rounded-md shadow-sm" required>
                </div>
                <div>
                    <label for="repeated" class="block text-sm font-medium">Repeated Percent</label>
                    <input type="number" step="0.01" id="repeated" name="repeated" class="mt-1 block w-full rounded-md shadow-sm" required>
                </div>
                <div>
                    <label for="campaign_name" class="block text-sm font-medium">Campaign Name</label>
                    <input type="text" id="campaign_name" name="campaign_name" class="mt-1 block w-full rounded-md shadow-sm">
                </div>
                <div class="md:col-span-2">
                    <button type="submit" name="add_url" class="btn-primary text-white font-medium py-2 px-6 rounded-lg flex items-center space-x-2 mx-auto">
                        <i class="fas fa-plus"></i>
                        <span>Add URL</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Add Device Form -->
        <div class="card shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-semibold text-gray-100 mb-4">Add New Device</h2>
            <form id="device-form" method="POST" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="adb_id" class="block text-sm font-medium">ADB ID</label>
                    <input type="text" id="adb_id" name="adb_id" class="mt-1 block w-full rounded-md shadow-sm" required>
                </div>
                <div>
                    <label for="asset_no" class="block text-sm font-medium">Asset Number</label>
                    <input type="text" id="asset_no" name="asset_no" class="mt-1 block w-full rounded-md shadow-sm" required>
                </div>
                <div>
                    <label for="state" class="block text-sm font-medium">State</label>
                    <input type="text" id="state" name="state" class="mt-1 block w-full rounded-md shadow-sm" required>
                </div>
                <div class="md:col-span-3">
                    <button type="submit" name="add_device" class="btn-primary text-white font-medium py-2 px-6 rounded-lg flex items-center space-x-2 mx-auto">
                        <i class="fas fa-plus"></i>
                        <span>Add Device</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- URLs Table -->
        <div class="card shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-semibold text-gray-100 mb-4">URLs</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr>
                            <th class="p-3 text-sm font-semibold text-gray-300">ID</th>
                            <th class="p-3 text-sm font-semibold text-gray-300" style="width: 36%;">URL</th>
                            <th class="p-3 text-sm font-semibold text-gray-300">Target Clicks</th>
                            <th class="p-3 text-sm font-semibold text-gray-300">Unique %</th>
                            <th class="p-3 text-sm font-semibold text-gray-300">Repeated %</th>
                            <th class="p-3 text-sm font-semibold text-gray-300">Campaign</th>
                            <th class="p-3 text-sm font-semibold text-gray-300">Selected</th>
                            <th class="p-3 text-sm font-semibold text-gray-300">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="urls-table">
                        {% for url in urls %}
                        <tr class="{% if url.is_selected %}selected-row{% endif %}">
                            <td class="p-3 text-gray-400">{{ url.id }}</td>
                            <td class="p-3 text-gray-400">{{ url.url }}</td>
                            <td class="p-3 text-gray-400">{{ url.target_clicks }}</td>
                            <td class="p-3 text-gray-400">{{ url.unique_percent }}</td>
                            <td class="p-3 text-gray-400">{{ url.repeated_percent }}</td>
                            <td class="p-3 text-gray-400">{{ url.campaign_name }}</td>
                            <td class="p-3">
                                <input type="checkbox" onchange="toggleUrlSelection({{ url.id }}, this)" {% if url.is_selected %}checked{% endif %}>
                            </td>
                            <td class="p-3">
                                <button class="bg-purple-600 hover:bg-purple-700 text-white py-1 px-3 rounded mr-2 action-btn" 
                                        onclick="openUrlModal({{ url.id }}, '{{ url.url | safe }}', {{ url.target_clicks }}, {{ url.unique_percent }}, {{ url.repeated_percent }}, '{{ url.campaign_name | safe }}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-danger text-white py-1 px-3 rounded action-btn" 
                                        onclick="deleteUrl({{ url.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Devices Table -->
        <div class="card shadow-lg p-6">
            <h2 class="text-2xl font-semibold text-gray-100 mb-4">Devices</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr>
                            <th class="p-3 text-sm font-semibold text-gray-300">ID</th>
                            <th class="p-3 text-sm font-semibold text-gray-300">ADB ID</th>
                            <th class="p-3 text-sm font-semibold text-gray-300">Asset No</th>
                            <th class="p-3 text-sm font-semibold text-gray-300">State</th>
                            <th class="p-3 text-sm font-semibold text-gray-300">Selected</th>
                            <th class="p-3 text-sm font-semibold text-gray-300">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="devices-table">
                        {% for device in devices %}
                        <tr class="{% if device.is_selected %}selected-row{% endif %}">
                            <td class="p-3 text-gray-400">{{ device.id }}</td>
                            <td class="p-3 text-gray-400">{{ device.adb_id }}</td>
                            <td class="p-3 text-gray-400">{{ device.asset_no }}</td>
                            <td class="p-3 text-gray-400">{{ device.state }}</td>
                            <td class="p-3">
                                <input type="checkbox" onchange="toggleDeviceSelection({{ device.id }}, this)" {% if device.is_selected %}checked{% endif %}>
                            </td>
                            <td class="p-3">
                                <button class="bg-purple-600 hover:bg-purple-700 text-white py-1 px-3 rounded mr-2 action-btn" 
                                        onclick="openDeviceModal({{ device.id }}, '{{ device.adb_id | safe }}', '{{ device.asset_no | safe }}', '{{ device.state | safe }}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-danger text-white py-1 px-3 rounded action-btn" 
                                        onclick="deleteDevice({{ device.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- URL Update Modal -->
        <div class="fixed inset-0 bg-black bg-opacity-70 hidden" id="urlModal">
            <div class="modal-content bg-gray-800 rounded-lg p-6 max-w-lg mx-auto mt-20">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-100">Update URL</h2>
                    <button onclick="document.getElementById('urlModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="update-url-form">
                    <input type="hidden" id="update-url-id" name="id">
                    <div class="mb-4">
                        <label for="update-url" class="block text-sm font-medium text-gray-300">URL</label>
                        <input type="text" id="update-url" name="url" class="mt-1 block w-full rounded-md shadow-sm" required>
                    </div>
                    <div class="mb-4">
                        <label for="update-target" class="block text-sm font-medium text-gray-300">Target Clicks</label>
                        <input type="number" id="update-target" name="target" class="mt-1 block w-full rounded-md shadow-sm" required>
                    </div>
                    <div class="mb-4">
                        <label for="update-unique" class="block text-sm font-medium text-gray-300">Unique Percent</label>
                        <input type="number" step="0.01" id="update-unique" name="unique" class="mt-1 block w-full rounded-md shadow-sm" required>
                    </div>
                    <div class="mb-4">
                        <label for="update-repeated" class="block text-sm font-medium text-gray-300">Repeated Percent</label>
                        <input type="number" step="0.01" id="update-repeated" name="repeated" class="mt-1 block w-full rounded-md shadow-sm" required>
                    </div>
                    <div class="mb-4">
                        <label for="update-campaign_name" class="block text-sm font-medium text-gray-300">Campaign Name</label>
                        <input type="text" id="update-campaign_name" name="campaign_name" class="mt-1 block w-full rounded-md shadow-sm">
                    </div>
                    <button type="submit" class="btn-primary text-white font-medium py-2 px-6 rounded-lg flex items-center space-x-2">
                        <i class="fas fa-save"></i>
                        <span>Update URL</span>
                    </button>
                </form>
            </div>
        </div>

        <!-- Device Update Modal -->
        <div class="fixed inset-0 bg-black bg-opacity-70 hidden" id="deviceModal">
            <div class="modal-content bg-gray-800 rounded-lg p-6 max-w-lg mx-auto mt-20">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-100">Update Device</h2>
                    <button onclick="document.getElementById('deviceModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="update-device-form">
                    <input type="hidden" id="update-device-id" name="id">
                    <div class="mb-4">
                        <label for="update-adb_id" class="block text-sm font-medium text-gray-300">ADB ID</label>
                        <input type="text" id="update-adb_id" name="adb_id" class="mt-1 block w-full rounded-md shadow-sm" required>
                    </div>
                    <div class="mb-4">
                        <label for="update-asset_no" class="block text-sm font-medium text-gray-300">Asset Number</label>
                        <input type="text" id="update-asset_no" name="asset_no" class="mt-1 block w-full rounded-md shadow-sm" required>
                    </div>
                    <div class="mb-4">
                        <label for="update-state" class="block text-sm font-medium text-gray-300">State</label>
                        <input type="text" id="update-state" name="state" class="mt-1 block w-full rounded-md shadow-sm" required>
                    </div>
                    <button type="submit" class="btn-primary text-white font-medium py-2 px-6 rounded-lg flex items-center space-x-2">
                        <i class="fas fa-save"></i>
                        <span>Update Device</span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            const alertMessage = document.getElementById('alert-message');
            alert.className = `fixed top-4 right-4 z-50 p-4 rounded-lg text-white alert bg-${type === 'success' ? 'green' : 'red'}-600`;
            alertMessage.textContent = message;
            alert.classList.remove('hidden');
            setTimeout(() => alert.classList.add('hidden'), 3000);
        }

        function updateSelectedSummary() {
            fetch('/used_devices')
                .then(response => response.json())
                .then(devices => {
                    const selectedDevices = document.getElementById('selected-devices');
                    selectedDevices.innerHTML = devices.length ? devices.map(d => `<li>${d.asset_no}</li>`).join('') : '<li>No devices selected</li>';
                });
            fetch('/used_urls')
                .then(response => response.json())
                .then(urls => {
                    const selectedUrls = document.getElementById('selected-urls');
                    selectedUrls.innerHTML = urls.length ? urls.map(u => `<li>${u.campaign_name || 'No campaign'}</li>`).join('') : '<li>No URLs selected</li>';
                });
        }

        function toggleUrlSelection(id, checkbox) {
            fetch(`/toggle_url_selection/${id}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    showAlert(data.message, data.error ? 'danger' : 'success');
                    if (!data.error) {
                        const row = checkbox.closest('tr');
                        if (checkbox.checked) {
                            row.classList.add('selected-row');
                        } else {
                            row.classList.remove('selected-row');
                        }
                        updateSelectedSummary();
                    } else {
                        checkbox.checked = !checkbox.checked;
                    }
                })
                .catch(error => {
                    checkbox.checked = !checkbox.checked;
                    showAlert('Error toggling URL selection', 'danger');
                    console.error(error);
                });
        }

        function toggleDeviceSelection(id, checkbox) {
            fetch(`/toggle_device_selection/${id}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    showAlert(data.message, data.error ? 'danger' : 'success');
                    if (!data.error) {
                        const row = checkbox.closest('tr');
                        if (checkbox.checked) {
                            row.classList.add('selected-row');
                        } else {
                            row.classList.remove('selected-row');
                        }
                        updateSelectedSummary();
                    } else {
                        checkbox.checked = !checkbox.checked;
                    }
                })
                .catch(error => {
                    checkbox.checked = !checkbox.checked;
                    showAlert('Error toggling device selection', 'danger');
                    console.error(error);
                });
        }

        function deleteUrl(id) {
            if (confirm('Are you sure you want to delete this URL?')) {
                fetch(`/delete_url/${id}`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        showAlert(data.message, data.error ? 'danger' : 'success');
                        if (!data.error) {
                            setTimeout(() => location.reload(), 1000);
                        }
                    })
                    .catch(error => {
                        showAlert('Error deleting URL', 'danger');
                        console.error(error);
                    });
            }
        }

        function deleteDevice(id) {
            if (confirm('Are you sure you want to delete this device?')) {
                fetch(`/delete_device/${id}`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        showAlert(data.message, data.error ? 'danger' : 'success');
                        if (!data.error) {
                            setTimeout(() => location.reload(), 1000);
                        }
                    })
                    .catch(error => {
                        showAlert('Error deleting device', 'danger');
                        console.error(error);
                    });
            }
        }

        function openUrlModal(id, url, target, unique, repeated, campaign_name) {
            document.getElementById('update-url-id').value = id;
            document.getElementById('update-url').value = url;
            document.getElementById('update-target').value = target;
            document.getElementById('update-unique').value = unique;
            document.getElementById('update-repeated').value = repeated;
            document.getElementById('update-campaign_name').value = campaign_name;
            document.getElementById('urlModal').classList.remove('hidden');
        }

        function openDeviceModal(id, adb_id, asset_no, state) {
            document.getElementById('update-device-id').value = id;
            document.getElementById('update-adb_id').value = adb_id;
            document.getElementById('update-asset_no').value = asset_no;
            document.getElementById('update-state').value = state;
            document.getElementById('deviceModal').classList.remove('hidden');
        }

        document.getElementById('url-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch('/', { method: 'POST', body: formData })
                .then(response => {
                    if (response.ok) {
                        showAlert('URL added successfully!', 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        return response.json().then(data => { throw new Error(data.error); });
                    }
                })
                .catch(error => {
                    showAlert(error.message || 'Error adding URL', 'danger');
                    console.error(error);
                });
        });

        document.getElementById('device-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch('/', { method: 'POST', body: formData })
                .then(response => {
                    if (response.ok) {
                        showAlert('Device added successfully!', 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        return response.json().then(data => { throw new Error(data.error); });
                    }
                })
                .catch(error => {
                    showAlert(error.message || 'Error adding device', 'danger');
                    console.error(error);
                });
        });

        document.getElementById('update-url-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const id = document.getElementById('update-url-id').value;
            const formData = new FormData(this);
            fetch(`/update_url/${id}`, { method: 'POST', body: formData })
                .then(response => response.json())
                .then(data => {
                    showAlert(data.message, data.error ? 'danger' : 'success');
                    if (!data.error) {
                        document.getElementById('urlModal').classList.add('hidden');
                        setTimeout(() => location.reload(), 1000);
                    }
                })
                .catch(error => {
                    showAlert('Error updating URL', 'danger');
                    console.error(error);
                });
        });

        document.getElementById('update-device-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const id = document.getElementById('update-device-id').value;
            const formData = new FormData(this);
            fetch(`/update_device/${id}`, { method: 'POST', body: formData })
                .then(response => response.json())
                .then(data => {
                    showAlert(data.message, data.error ? 'danger' : 'success');
                    if (!data.error) {
                        document.getElementById('deviceModal').classList.add('hidden');
                        setTimeout(() => location.reload(), 1000);
                    }
                })
                .catch(error => {
                    showAlert('Error updating device', 'danger');
                    console.error(error);
                });
        });

        function runScript() {
            fetch('/run-script', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    showAlert(data.message, data.message.includes('Failed') ? 'danger' : 'success');
                })
                .catch(error => {
                    showAlert('Error running script', 'danger');
                    console.error(error);
                });
        }

        function stopScript() {
            fetch('/stop-script', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    showAlert(data.message, data.message.includes('Failed') ? 'danger' : 'success');
                })
                .catch(error => {
                    showAlert('Error stopping script', 'danger');
                    console.error(error);
                });
        }

        // Initialize selected summary on page load
        document.addEventListener('DOMContentLoaded', updateSelectedSummary);
    </script>
</body>
</html>